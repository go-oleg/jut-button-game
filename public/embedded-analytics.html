<html>
<head>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js"></script>
    <title></title>
</head>
<body>
    <script type="text/javascript">

        var websocket = new WebSocket("wss://data-engine-127-94-0-1.jutdatatest.com:3100/api/v1/juttle/channel");

        var channel_id;

        websocket.onopen = function(event) {
            console.log('websocket opened');

            var auth_message = {
                embedded_analytics_id: 1
            };
            // if (self.job_id) {
            //     auth_message.job_id = self.job_id;
            // } else if (self.channel_id) {
            //     auth_message.channel_id = self.channel_id;
            // }
            websocket.send(JSON.stringify(auth_message));
        };

        websocket.onerror = function(event) {
            console.log('websocket error');
            console.log(event);
        };

        websocket.onclose = function(event) {
            console.log('websocket closed');
            console.log(event);
        };

        websocket.onmessage = function(event) {
            var msg;
            console.log('event data: ' + event.data);
            try {
                msg = JSON.parse(event.data);
            }
            catch(err) {
                console.log('warning: not able to parse message: ' + err);
                return;
            }

            if (msg.channel_id) {
                channel_id = msg.channel_id;
                $.ajax({
                    url: "https://data-engine-127-94-0-1.jutdatatest.com:3100/api/v1/juttle-snapshot-jobs",
                    type: "POST",
                    // xhrFields: { withCredentials: true },
                    // xhr: function() {
                    //             realXHR = $.ajaxSettings.xhr();
                    //             return realXHR;
                    //         },
                    // headers: {
                    //     "Authorization": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzUxMiJ9.eyJhY2NvdW50X2lkIjoiOGEzMWFhZDktYTg4Mi00NzVlLThhNWUtNGMwM2I4NGUyNjYyIiwiaWF0IjoxNDQ0NDAyMDY3LCJleHAiOjE0NDQ0MDU2NjcsImlzcyI6InVybjphdXRoIn0.CSCxZpEnxenIB5FpaIVa7863T2QGA650y78uvL_sCJ1pmYuhBuVpu0JdX5YqCxgt5X6YnN2jj4KUXfZ8yhc-3J7PCgk0_Qx6lykQVYZAXAWu2PRXTWSMDOBdJMIOIYPihVe6PlXyeROZ5FrZ26CSAoTad7zub9y5UMnGuuYHFBQ",
                    //     // "Access-Control-Request-Method":"POST",
                    //     // "Access-Control-Request-Headers": "accept, authorization, content-type",
                    //     // "Content-Type": "application/json"
                    //     // "Origin": "http://localhost:3000",
                    //     // "Host": "data-engine-127-94-0-1.jutdatatest.com:3100",
                    // },
                    contentType: "application/json",
                    data: JSON.stringify({
                        channel_id: channel_id,
                        // juttle_snapshot_id: 'AVBnECf3jS7EphbDItJX'
                        juttle_snapshot_id: 'AVBnIdMEjS7EphbDItJZ'
                        // program: "emit -limit 2",
                        // modules: {
                        //     main: "emit -limit 2"
                        // },
                        // input_asts: {}
                    }),
                    dataType: "json",
                    success: function(data, textStatus) {
                        console.log(data);
                        console.log(textStatus);
                    }
                })
            }

            if(msg.ping) {
                websocket.send(JSON.stringify({ pong: true }));
            }


        }
    </script>

</body>
</html>
